define(["events","js!"+z.mootoolsUrl],function(e){function i(e,t,n,r){u().pathname=="/web-development-tools"&&curl(t,n),r&&n()}function s(e){var t=u(),n=e.replace(t.protocol+"//"+t.host,"");return n}function o(){return $(z.d.body)}function u(){return z.w.location}function a(e,t,n){var r;return function(){var i=this,s=arguments;clearTimeout(r),r=setTimeout(function(){r=null,n||e.apply(i,s)},t),n&&!r&&e.apply(i,s)}}var t,n="keyup",r="click";o().addEvent(r+":relay(.dropdown a)",function(e,t){var n=t.getParent(".dropdown"),r="display";n.setStyle(r,"none"),setTimeout(function(){n.setStyle(r,"")},1e3)}),curl(["social"],function(t){function n(){setTimeout(function(){t.reload()},300)}n(),z.ajaxPageLoads&&e.subscribe("/page/ready",n)}),z.loadStats&&curl(["analytics"],function(t){function i(e){o().addEvent(r+":relay("+e+")",function(e,n){t.trackEvent("feature",n.href)})}var n=function(){t.trackPageView()};z.ajaxPageLoads&&e.subscribe("/page/loaded",n),z.ajaxPageLoads&&e.subscribe("/page/democlosed",n),i("a.feature","feature"),i("a.nextPrevLink","nextprev"),i(".related a","related"),i(".dropdown a","menu")}),z.loadAds&&curl(["ads"],function(t){e.subscribe("/page/ready",function(){t.reload()}),t.reload()}),curl(["syntax"],function(t){t.highlightPost(),e.subscribe("comments/added",function(e){t.highlightComments("li[data-comment="+e.li.get("data-comment")+"]")}),z.ajaxPageLoads&&e.subscribe("/page/ready",t.highlightPost)}),z.loadSearch&&curl(["search"],function(e){var t=$("q");t.addEvent("focus",function(){e.input=t,t.addEvent(n,a(function(n){t.value&&e.search(n)},800))})}),curl(["comments","syntax"],function(t,n){e.subscribe("/comments/added",function(){$$(".noCommentsText").setStyle("display","none")}),t.setReplyLinks(),e.subscribe("/page/ready",function(){t.setReplyLinks()}),o().addEvent("submit:relay(#cForm)",function(e,n){e.stop(),t.submitForm(n)}),o().addEvent("keydown:relay(#comment)",function(e){e.code==9&&(e.preventDefault(),$$("#commentForm input[name=submit]")[0].focus())}),e.subscribe("/page/ready",function(){t.setAvatars(),n.highlightComments()}),t.setAvatars(),e.publish("comments/loaded"),n.highlightComments(),o().addEvent(r+":relay(#commentUseEditor)",function(e,n){t.createEditor(e,n)}),e.subscribe("/page/ready",function(){t.aceSession=null})}),z.loadSidebar&&curl(["storage","ads"],function(e,t){function i(e){var n=(new Element("div",{html:e})).getFirst(".right");n.inject($$("section.left")[0],"after"),n.addClass("fadeIn"),t.reload(n)}var n,r;n="sidebar",r=e.get(n),r?i(r):curl(["text!"+z.themePath+n+".php"],function(t){i(t),e.set(n,t,z.sidebarCacheMinutes)})}),curl(["js!lib/mootools-more/Fx.Scroll.js"],function(){function f(){function e(e){e.addClass("focused"),r.toElement(e)}if(t)return;t=1,r=new Fx.Scroll(z.w,{onComplete:function(){$$(a)[0].getFirst("."+i+" h2 a, ."+i+" h1 a").focus()}}),o().addEvent(n,function(t){var n,r,o,f,l,c=t.code;targetTag=t.target.tagName;if(!c||c!=s&&c!=u)return;if(targetTag=="TEXTAREA"||targetTag=="INPUT"||targetTag=="SELECT")return;n=$$(a);if(!n.length)return;n=n[0],n.addClass("focusable"),r=n.getChildren(),o=n.getFirst("."+i),f=o&&o.getNext(),l=o&&o.getPrevious(),c==s&&l?o&&l&&(t.stop(),o.removeClass(i),e(l)):c==u&&(o&&f?(t.stop(),o.removeClass(i),e(f)):o||(t.stop(),e(n.getFirst())))})}function l(){$$(a).length&&f()}var t,r,i="focused",s=38,u=40,a=".postList";l(),e.subscribe("/page/ready",function(){currentFocus=-1,l()})}),z.ajaxPageLoads&&curl(["js!lib/mootools-history/Source/History.js","js!lib/mootools-more/Fx.Scroll.js"],function(){function m(e){var t,n,r="CONTENT",i={postContent:e.substring(e.indexOf("<!--"+r+"-->"),e.indexOf("<!--/"+r+"-->")),title:e.match(/<title>(.*)<\/title>/)[1]},o=e.match(/body class="(.*)"/);return i.classes=o&&o[1]?o[1]:"",t=e.match(/<link rel="canonical" href="(.*)"/),n=u()+"",i.canonical=t&&t.length>1?t[1]:n,i.classes.indexOf("cacheable")!=-1&&(v[s(n)]=e),i}function g(){var e=u().hash.replace("#",""),t=$$("#"+e+", a[name="+e+"]");return e&&t.length?t[0]:0}function y(){o().addClass(f)}function b(){o().removeClass(f)}function w(n){function s(e){t||(t=new Fx.Scroll(z.w,{duration:z.isMobile?10:350,onComplete:function(){if(e!=$("top"))try{e.focus()}catch(t){}}})),t.toElement(e)}var r;if(z.d.body.hasClass("demo"))return e.publish("/page/democlosed"),a!=undefined&&setTimeout(function(){z.w.scrollTo(0,a);try{i&&i.focus()}catch(e){}},50),z.d.body.removeClass("demo");e.publish("/page/loaded"),r=m(n),o().className=r.classes,$$("section.left").set("html",r.postContent),$$("title").set("html",r.title),$$("link[rel=canonical]").set("href",r.canonical),s(g()||$("top")),e.publish("/page/ready")}var t,i,a,f,l,c,h,p,d,v={};m(z.d.documentElement.innerHTML),o().addEvent(r+":relay(a:not([href=#],[href=javascript:;],[data-noxhr]))",function(e,t){var n,r,s;i=e.target,a=window.scrollY;if(e.meta||e.control||e.event.which==2||t.href.indexOf("davidwalsh.name")==-1)return;n=t.href,r=u(),s=r+"";if(n.indexOf(r.host)==-1||n.split("#")[0]==s.split("#")[0]||t.hasClass("post-edit-link"))return;e.stop(),History.push(n)}),f="working pageLoading",l=new Request({method:"get",timeout:1e4,link:"cancel",onRequest:y,onSuccess:w,onFailure:function(){window.location=window.location+""},onComplete:b}),c="demo",History.addEvent("change",function(e){var e,t,n,r,i,a,f;l.cancel(),t=g();if(!z.d.body.hasClass("demo")&&t)return;e=function(){var t=u();return e.indexOf("http")==-1&&(e=t.protocol+"//"+t.host+e),e}(),e.indexOf("/"+c+"/")!=-1?(p||(n="$$('.demoIframe').destroy();History.back();return false;",p=(new Element("div",{"class":c+"Box",html:'<div class="'+c+'Toolbar"> 									<span class="intro">Demo for: 										<a href="javascript:;" onclick="'+n+'"></a> 									</span> 									<a href="javascript:;" class="close data-noxhr" onclick="'+n+'">Close</a>							   </div><div class="'+c+'IframeHolder"></div>'})).inject(o())),d=(new IFrame({src:e,frameborder:0,"class":"demoIframe",events:{load:function(){try{d.contentWindow.document.documentElement.className="demoFrame"}catch(e){}}}})).inject(p.getFirst("."+c+"IframeHolder")),h=p.getElements(".intro a")[0],d.addClass("fadeIn"),d.src=e+"?",r=u(),i=$$("a[href="+e+"]"),a=$$("h1, h2")[0].innerHTML,i.length&&(f=i[0].getParent("li"),f&&(a=f.getFirst("h2 a").innerHTML)),h.set("html",a),o().addClass(c)):v[s(e)]?(y(),b(),w(v[s(e)])):(l.url=e,l.send())}),function(){function s(){function s(t,n,r){if(t==n&&r){r.hasClass(i)?History.push(r.href):(r.addClass(i),e=setTimeout(function(){r&&r.removeClass(i)},5e3));return}}o().addEvent(n,function(e){var n=e.code,i=e.target.tagName;if(i=="TEXTAREA"||i=="INPUT")return;$$(".nextPrevLink").length&&(s(n,t,$("prevLink")),s(n,r,$("nextLink")))})}var e,t=37,r=39,i="showFull";s()}(),z.d.documentElement.className+=" history",o().addEvent(r+":relay(.kwicks li > div)",function(e,t){$(e.target).get("tag")!="a"&&History.push(t.get("data-href"))});if(!z.isMobile&&!Browser.ie){function E(){var e;u().pathname=="/"&&(e=$$(".explode"))&&e.length&&curl(["explode"],function(t){t(e,12,12)})}E(),e.subscribe("/page/ready",E)}}),z.isMobile&&curl(["js!lib/mootools-custom-event/Source/Element.defineCustomEvent.js!order","js!lib/mootools-mobile/Source/Browser/Features.Touch.js!order","js!lib/mootools-mobile/Source/Touch/Swipe.js!order"],function(){var e=z.d.body;e.store("swipe:distance",150),e.store("swipe:cancelVertical",!0),e.addEvent("swipe",function(e){var t=$$(".nextPrevLink");if(!t.length)return;History.push($(e.direction=="right"?"prevLink":"nextLink").href)})}),!z.isMobile&&i("/web-development-tools",["dev-tools"],function(e){z.tools=e},1),i("/deals",null,function(){t||(o().addEvent(r+":relay(.dealList li)",function(e,t){var n=t.get("data-url");window.location=n}),t=1)},1),(new Element("a",{html:"<strong>BETA</strong> File a bug.","class":"catty",target:"_blank",href:"//github.com/darkwing/blog/issues"})).inject($$("header .headerTitle")[0]),(new Element("div",{id:"indicator"})).inject(o()),o().addEvent(r+":relay(.sexyRelated)",function(e,t){t.getParent().getElements(".relatedSns").toggleClass("show")}),window.addSNSTag=function(e){var t=$("tags"),n=t.value,r=n.split(",");r.push(e),r=r.filter(function(e){return e.trim()!=""}),t.value=r.join(", ").replace(/  /g," ")}});